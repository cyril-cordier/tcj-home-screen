<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Affichage Dynamique TC Jocassien</title>
<style>
html, body { margin:0; padding:0; height:100%; font-family:Arial,sans-serif; background:#111; color:#fff; }
#container { display:flex; height:100%; }
#sidebar { width:10%; display:flex; flex-direction:column; justify-content:center; align-items:center; padding:10px; box-sizing:border-box; background:#222; }
#logo img { width:80%; max-width:100px; height:auto; margin-bottom:20px; }
#datetime { text-align:center; margin-top:auto; margin-bottom:10px; }
#date { font-size:1.2em; margin-bottom:5px; }
#clock { font-size:2em; }
#carousel { width:90%; position:relative; overflow:hidden; background:#000; display:flex; justify-content:center; align-items:center; }
.carousel-item { position:absolute; width:100%; height:100%; display:flex; justify-content:center; align-items:center; opacity:0; transition:opacity 1s ease; }
.carousel-item.active { opacity:1; z-index:1; }
.carousel-item img, .carousel-item video, .carousel-item iframe { max-width:100%; max-height:100%; object-fit:contain; }
.carousel-item iframe { border:none; width:100%; height:100%; }
</style>
</head>
<body>
<div id="container">
  <div id="sidebar">
    <div id="logo">
      <img src="logo-TCJ.jpg" alt="Logo TC Jocassien">
    </div>
    <div id="datetime">
      <div id="date"></div>
      <div id="clock"></div>
    </div>
  </div>
  <div id="carousel"></div>
</div>

<script>
// URL de ton serveur Render
const PROXY_URL = 'https://tcj-proxy.onrender.com';
const carousel = document.getElementById('carousel');
let items=[], currentIndex=0, timer;

// Date et horloge
function updateDateTime() {
  const now = new Date();
  document.getElementById('date').textContent = now.toLocaleDateString('fr-FR', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
  const h = String(now.getHours()).padStart(2,'0');
  const m = String(now.getMinutes()).padStart(2,'0');
  const s = String(now.getSeconds()).padStart(2,'0');
  document.getElementById('clock').textContent = `${h}:${m}:${s}`;
}
setInterval(updateDateTime,1000);
updateDateTime();

// Récupération fichiers via le proxy
async function fetchFiles() {
  try {
    const res = await fetch(`${PROXY_URL}/files`);
    const data = await res.json();
    items = data.map(file => {
      if(file.mimeType.startsWith('image/')) {
        return { type:'image', url:`${PROXY_URL}/file/${file.id}`, duration:8000 };
      } else if(file.mimeType.startsWith('video/')) {
        return { type:'video', url:`${PROXY_URL}/file/${file.id}`, duration:15000 };
      } else if(file.mimeType==='application/pdf') {
        return { type:'pdf', url:`${PROXY_URL}/file/${file.id}`, duration:20000 };
      } else return null;
    }).filter(Boolean);

    displayCarousel();
    startCarousel();
  } catch(e){
    console.error('Erreur récupération fichiers:', e);
  }
}

// Création éléments carrousel
function displayCarousel() {
  carousel.innerHTML='';
  items.forEach((item,index)=>{
    const div = document.createElement('div');
    div.className = 'carousel-item' + (index===0 ? ' active' : '');
    if(item.type==='image') { const img = document.createElement('img'); img.src = item.url; div.appendChild(img); }
    else if(item.type==='video') { const vid = document.createElement('video'); vid.src = item.url; vid.autoplay=true; vid.loop=true; vid.muted=true; div.appendChild(vid); }
    else if(item.type==='pdf') { const iframe = document.createElement('iframe'); iframe.src = item.url; div.appendChild(iframe); }
    carousel.appendChild(div);
  });
}

// Passage au suivant
function nextItem() {
  const elems = document.querySelectorAll('.carousel-item');
  if(elems.length===0) return;
  elems[currentIndex].classList.remove('active');
  currentIndex = (currentIndex+1)%elems.length;
  elems[currentIndex].classList.add('active');
  clearTimeout(timer);
  timer = setTimeout(nextItem, items[currentIndex].duration);
}

function startCarousel() { if(items.length===0) return; timer=setTimeout(nextItem, items[0].duration); }

// Rafraîchissement automatique toutes les 20 minutes
setInterval(() => {
  console.log('Rafraîchissement du contenu via proxy...');
  fetchFiles();
}, 1200000); // 20 minutes

// Premier chargement
fetchFiles();
</script>
</body>
</html>
