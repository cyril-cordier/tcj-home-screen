<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Affichage Dynamique TC Jocassien</title>
<style>
html, body { margin:0; padding:0; height:100%; font-family:Arial,sans-serif; background:#111; color:#fff; }
#container { display:flex; height:100%; }
#sidebar { width:10%; display:flex; flex-direction:column; justify-content:center; align-items:center; padding:10px; box-sizing:border-box; background:#222; }
#logo img { 
  width: 100%;        /* pleine largeur de la sidebar */
  height: auto;       
  margin-bottom: 20px;
  animation: pulse 3s infinite ease-in-out;
  border: none;
  background: none;
  border-radius: 50%; /* si image ronde */
  box-shadow: none;
}
@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.05); }
  100% { transform: scale(1); }
}
#datetime { text-align:center; margin-top:auto; margin-bottom:10px; }
#date { font-size:1.2em; margin-bottom:5px; }
#clock { font-size:2em; }
#carousel { width:90%; position:relative; overflow:hidden; background:#000; display:flex; justify-content:center; align-items:center; }
.carousel-item { position:absolute; width:100%; height:100%; display:flex; justify-content:center; align-items:center; opacity:0; transition:opacity 1s ease; }
.carousel-item.active { opacity:1; z-index:1; }
.carousel-item img, .carousel-item video, .carousel-item canvas { max-width:100%; max-height:100%; object-fit:contain; display:block; }
#empty-logo { position:absolute; top:0; left:10%; width:90%; height:100%; display:flex; justify-content:center; align-items:center; background:#000; z-index:1; }
#empty-logo img { max-width:80%; max-height:80%; }
</style>
</head>
<body>
<div id="container">
  <div id="sidebar">
    <div id="logo">
      <img src="logo-TCJ.jpg" alt="Logo TC Jocassien">
    </div>
    <div id="datetime">
      <div id="date"></div>
      <div id="clock"></div>
    </div>
  </div>
  <div id="carousel"></div>
  <div id="empty-logo" style="display:none;">
    <img src="logo-TCJ.jpg" alt="Logo TC Jocassien">
  </div>
</div>

<!-- pdf.js CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.177/pdf.min.js"></script>
<script>
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.177/pdf.worker.min.js';
</script>

<script>
const PROXY_URL = 'https://tcj-proxy.onrender.com';
const carousel = document.getElementById('carousel');
const emptyLogoDiv = document.getElementById('empty-logo');
let items=[], currentIndex=0, timer;

// Date et horloge
function updateDateTime() {
  const now = new Date();
  document.getElementById('date').textContent = now.toLocaleDateString('fr-FR', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
  const h = String(now.getHours()).padStart(2,'0');
  const m = String(now.getMinutes()).padStart(2,'0');
  const s = String(now.getSeconds()).padStart(2,'0');
  document.getElementById('clock').textContent = `${h}:${m}:${s}`;
}
setInterval(updateDateTime,1000);
updateDateTime();

// Récupération fichiers via proxy
async function fetchFiles() {
  try {
    const res = await fetch(`${PROXY_URL}/files`);
    const data = await res.json();
    if(!data.files || !Array.isArray(data.files) || data.files.length===0) {
      console.log('Aucun fichier trouvé, affichage logo plein écran');
      items = [];
      carousel.innerHTML = '';
      emptyLogoDiv.style.display = 'flex';
      return;
    }

    emptyLogoDiv.style.display = 'none';

    items = data.files.map(file => {
      if(file.mimeType.startsWith('image/')) {
        return { type:'image', url:`${PROXY_URL}/file/${file.id}`, duration:8000 };
      } else if(file.mimeType.startsWith('video/')) {
        return { type:'video', url:`${PROXY_URL}/file/${file.id}`, duration:15000 };
      } else if(file.mimeType==='application/pdf') {
        return { type:'pdf', url:`${PROXY_URL}/file/${file.id}`, duration:20000 };
      } else return null;
    }).filter(Boolean);

    if(items.length===0) {
      console.log('Aucun fichier compatible, affichage logo plein écran');
      carousel.innerHTML = '';
      emptyLogoDiv.style.display = 'flex';
      return;
    }

    displayCarousel();
    startCarousel();

  } catch(e){
    console.error('Erreur récupération fichiers:', e);
    items = [];
    carousel.innerHTML = '';
    emptyLogoDiv.style.display = 'flex';
  }
}

// Création éléments carrousel
function displayCarousel() {
  carousel.innerHTML='';
  items.forEach((item,index)=>{
    const div = document.createElement('div');
    div.className = 'carousel-item' + (index===0 ? ' active' : '');

    if(item.type==='image') {
      const img = document.createElement('img');
      img.src = item.url;
      div.appendChild(img);

    } else if(item.type==='video') {
      const vid = document.createElement('video');
      vid.src = item.url;
      vid.autoplay=true;
      vid.loop=true;
      vid.muted=true;
      div.appendChild(vid);

    } else if(item.type==='pdf') {
      const canvas = document.createElement('canvas');
      div.appendChild(canvas);
      pdfjsLib.getDocument(item.url).promise.then(pdf => {
        pdf.getPage(1).then(page => {
          const viewport = page.getViewport({ scale:1.5 });
          canvas.width = viewport.width;
          canvas.height = viewport.height;
          page.render({ canvasContext: canvas.getContext('2d'), viewport: viewport });
        });
      });
    }

    carousel.appendChild(div);
  });
}

// Passage au suivant
function nextItem() {
  const elems = document.querySelectorAll('.carousel-item');
  if(elems.length===0) return;
  elems[currentIndex].classList.remove('active');
  currentIndex = (currentIndex+1)%elems.length;
  elems[currentIndex].classList.add('active');
  clearTimeout(timer);
  timer = setTimeout(nextItem, items[currentIndex].duration);
}

function startCarousel() { if(items.length===0) return; timer=setTimeout(nextItem, items[0].duration); }

// Rafraîchissement automatique toutes les 20 minutes
setInterval(() => {
  console.log('Rafraîchissement du contenu via proxy...');
  fetchFiles();
}, 1200000);

// Premier chargement
fetchFiles();
</script>
</body>
</html>
